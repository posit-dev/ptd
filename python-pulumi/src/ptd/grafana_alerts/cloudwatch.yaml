# To delete these alerts, simply removing the configMap that uses this method will not work.
# Replace file contents with the following and apply in order to delete the alerts:
# apiVersion: 1
# deleteRules:
#   - orgId: 1
#     uid: fsx_capacity
#
# See https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/file-provisioning/
apiVersion: 1
groups:
    - orgId: 1
      name: Cloudwatch
      folder: Posit Alerts
      interval: 5m
      rules:
        - uid: fsx_capacity
          title: FSx Capacity
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: mimir
              model:
                editorMode: code
                expr: aws_fsx_used_storage_capacity_average{job="integrations/cloudwatch", dimension_DataType!="Snapshot", dimension_VolumeId!=""} / aws_fsx_storage_capacity_average{job="integrations/cloudwatch", dimension_VolumeId!=""}
                instant: true
                intervalMs: 1000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0.8
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          noDataState: NoData
          execErrState: Error
          for: 5m
          annotations:
            summary: "ðŸŸ¡ WARNING: FSx Storage Capacity Low"
            description: |
              FSx file system is running low on storage capacity

              â”€â”€â”€ WHERE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Tenant:      {{ $labels.tenant_name }}
              Cluster:     {{ $labels.cluster }}
              Resource:    {{ $labels.dimension_FileSystemId }}
              Region:      {{ $labels.region }}

              â”€â”€â”€ DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Metric:      Storage Capacity
              Current:     > 80% used
              Threshold:   80%
              Duration:    5 minutes

              ðŸ“– https://github.com/posit-dev/ptd/blob/main/docs/runbooks/fsx-capacity-low.md
              ðŸ“Š https://grafana.example.com/d/cloudwatch?var-cluster={{ $labels.cluster }}
          labels:
            opsgenie: "1"
          isPaused: false
        - uid: ec2_network_out_high
          title: EC2 Network Out High
          condition: B
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: mimir
              model:
                editorMode: code
                # Network out threshold: 314572800 bytes/s (~300 MiB/s)
                # Based on analysis of Loki->S3 traffic patterns from issue #2347
                # Instance-aware thresholds: Using the same threshold for all instances
                # To set different thresholds by instance type, use:
                # avg_over_time(aws_ec2_network_out_average{job="integrations/cloudwatch", dimension_InstanceType="t3.xlarge"}[5m]) > 157286400 or
                # avg_over_time(aws_ec2_network_out_average{job="integrations/cloudwatch", dimension_InstanceType="m5.2xlarge"}[5m]) > 314572800
                expr: avg_over_time(aws_ec2_network_out_average{job="integrations/cloudwatch"}[5m])
                instant: true
                intervalMs: 1000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: B
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 3.145728e+08 # ~ 300 MiB/s
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: B
                type: threshold
          noDataState: NoData
          execErrState: Error
          for: 5m
          annotations:
            summary: "ðŸŸ¡ WARNING: EC2 Network Out High"
            description: |
              EC2 instance has unusually high outbound network traffic

              â”€â”€â”€ WHERE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Tenant:      {{ $labels.tenant_name }}
              Cluster:     {{ $labels.cluster }}
              Resource:    {{ $labels.dimension_InstanceId }}
              Region:      {{ $labels.region }}

              â”€â”€â”€ DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Metric:      Network Out
              Current:     > 300 MiB/s
              Threshold:   300 MiB/s
              Duration:    5 minutes

              ðŸ“– https://github.com/posit-dev/ptd/blob/main/docs/runbooks/ec2-network-high.md
              ðŸ“Š https://grafana.example.com/d/cloudwatch?var-cluster={{ $labels.cluster }}
          labels:
            opsgenie: "1"
          isPaused: false
        - uid: ec2_network_packets_out_high
          title: EC2 Network Packets Out High
          condition: B
          data:
            - refId: A
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: mimir
              model:
                editorMode: code
                # Network packets out threshold: 400000 packets/s
                # High packet rate can indicate network bottlenecks or unusual traffic patterns
                expr: avg_over_time(aws_ec2_network_packets_out_average{job="integrations/cloudwatch"}[5m])
                instant: true
                intervalMs: 1000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: B
              relativeTimeRange:
                from: 600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 400000
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: B
                type: threshold
          noDataState: NoData
          execErrState: Error
          for: 5m
          annotations:
            summary: "ðŸŸ¡ WARNING: EC2 Network Packets Out High"
            description: |
              EC2 instance has unusually high packet transmission rate

              â”€â”€â”€ WHERE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Tenant:      {{ $labels.tenant_name }}
              Cluster:     {{ $labels.cluster }}
              Resource:    {{ $labels.dimension_InstanceId }}
              Region:      {{ $labels.region }}

              â”€â”€â”€ DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Metric:      Network Packets Out
              Current:     > 400,000 packets/s
              Threshold:   400,000 packets/s
              Duration:    5 minutes

              ðŸ“– https://github.com/posit-dev/ptd/blob/main/docs/runbooks/ec2-network-high.md
              ðŸ“Š https://grafana.example.com/d/cloudwatch?var-cluster={{ $labels.cluster }}
          labels:
            opsgenie: "1"
          isPaused: false
