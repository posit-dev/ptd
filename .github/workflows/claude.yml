name: Claude PR Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

env:
  PTD_AWS_ACCOUNT: ${{ secrets.PTD_AWS_ACCOUNT }}

jobs:
  claude-code-action:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.PTD_AWS_ACCOUNT }}:role/claude-code
          role-session-name: gha-claude-code-action
          aws-region: us-east-2

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@beta
        with:
          model: "us.anthropic.claude-opus-4-6-v1"
          fallback_model: "us.anthropic.claude-3-7-sonnet-20250219-v1:0"
          timeout_minutes: "60"
          use_bedrock: true
          branch_prefix: "claude-"
          additional_permissions: "actions: read"
          allowed_tools: "mcp__github__create_pull_request,mcp__github__create_issue,mcp__github__search_issues,mcp__github__update_issue,mcp__github__create_pending_pull_request_review,mcp__github__add_pull_request_review_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff"
          custom_instructions: |
            You are a helpful AI assistant for code reviews and issue triage.
            Respond to comments and issues that mention you with relevant code suggestions or triage actions.
            If you cannot assist, politely inform the user. In your responses, don't be overly complimentary.
            Stick to the facts and provide actionable advice.
